/**
 * @brief       : 这个文件是os的任务创建部分
 *
 * @file        : wsnos_task.c
 * @author      : gang.cheng
 * @version     : v0.0.1
 * @date        : 2015/5/7
 *
 * Change Logs  :
 *
 * Date        Version      Author      Notes
 * 2015/5/7    v0.0.1      gang.cheng    first version
 */

#include "common/lib/lib.h"
#include "wsnos.h"

DBG_THIS_MODULE("wsnos_sched")

osel_uint8_t osel_rdy_grp = 0;
osel_uint8_t *osel_rdy_tbl = NULL;

osel_int8_t osel_curr_prio = -1;

osel_uint8_t const CODE osel_map_tbl[64] =
{
    0x01U, 0x02U, 0x04U, 0x08U, 0x10U, 0x20U, 0x40U, 0x80U,
    0x01U, 0x02U, 0x04U, 0x08U, 0x10U, 0x20U, 0x40U, 0x80U,
    0x01U, 0x02U, 0x04U, 0x08U, 0x10U, 0x20U, 0x40U, 0x80U,
    0x01U, 0x02U, 0x04U, 0x08U, 0x10U, 0x20U, 0x40U, 0x80U,
    0x01U, 0x02U, 0x04U, 0x08U, 0x10U, 0x20U, 0x40U, 0x80U,
    0x01U, 0x02U, 0x04U, 0x08U, 0x10U, 0x20U, 0x40U, 0x80U,
    0x01U, 0x02U, 0x04U, 0x08U, 0x10U, 0x20U, 0x40U, 0x80U,
    0x01U, 0x02U, 0x04U, 0x08U, 0x10U, 0x20U, 0x40U, 0x80U
};

static osel_uint8_t const CODE osel_unmap_tbl[] =
{
    0x00, 0x00, 0x01, 0x01, 0x02, 0x02, 0x02, 0x02,
    0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05,
    0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05,
    0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05,
    0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05,
    0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06,
    0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06,
    0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06,
    0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06,
    0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06,
    0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06,
    0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06,
    0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07
};


osel_int8_t osel_mutex_lock(osel_int8_t prio_ceiling)
{
    osel_int8_t mutex;
    osel_int_status_t status = 0;

    OSEL_ENTER_CRITICAL(status);
    mutex = osel_curr_prio;
    if (osel_curr_prio < prio_ceiling)
    {
        osel_curr_prio = prio_ceiling;
    }
    OSEL_EXIT_CRITICAL(status);

    return mutex;
}

void osel_mutex_unlock(osel_int8_t org_prio)
{
    osel_int_status_t status = 0;

    OSEL_ENTER_CRITICAL(status);
    if (osel_curr_prio > org_prio)
    {
        osel_curr_prio = org_prio;
        OSEL_POST_SIGNAL();   //osel_schedule();
    }
    OSEL_EXIT_CRITICAL(status);
}

void osel_post(osel_task_t *task, osel_pthread_t *p, osel_event_t *event)
{
    DBG_ASSERT(event != NULL __DBG_LINE);
    
    event->p = p;
    
    if(task == NULL)
    {
        if(p == NULL)
        {
            DBG_LOG(DBG_LEVEL_WARNING, "send event to null\r\n");
            return;
        }
        
        osel_task_t *tcb = p->tcb;
        if(tcb != NULL)
        {
            osel_equeue_post(&(tcb->equeue), event);
        }
        else
        {
            DBG_LOG(DBG_LEVEL_ERROR, "pthread assoc to null task\r\n");
            return;
        }
    }
    else
    {
        osel_equeue_post(&(task->equeue), event);
    }
}


void osel_schedule(void)
{
    osel_uint8_t x = 0, y = 0;
    osel_int8_t prio = 0;
    osel_int8_t pin = osel_curr_prio;

    while ((osel_rdy_grp > 0)
            && (y = osel_unmap_tbl[osel_rdy_grp]
                , x = osel_unmap_tbl[osel_rdy_tbl[y]]
                , (prio = (y << 3) + x) > pin))
    {
        osel_task_t *tcb = &g_task_list[prio];

        osel_curr_prio = prio;
        
        osel_event_t eblock;
        while (osel_equeue_get(&(tcb->equeue), &eblock) == OSEL_TRUE)
        {
            OSEL_INT_UNLOCK();
            if(tcb->entry != NULL){
                (*(tcb->entry))((void *)&eblock);
            }
            osel_pthread_poll(tcb, eblock);
            OSEL_INT_LOCK();
        }
        
        if ((osel_rdy_tbl[prio >> 3] &= ~osel_map_tbl[prio & 0x07]) == 0)
        {
            osel_rdy_grp &= ~osel_map_tbl[prio >> 3];
        }
    }

    osel_curr_prio = pin;
}
